# Chat Implementation - Quick Reference

## File Locations

| Purpose | File | Key Lines |
|---------|------|-----------|
| Database schema & functions | `/Users/mini/github/toronto/app/db.py` | Sessions: 89-96, Messages: 98-109 |
| Session management wrapper | `/Users/mini/github/toronto/app/memory/manager.py` | ConversationManager class: 15-196 |
| API endpoints | `/Users/mini/github/toronto/app/main.py` | Chat: 148-422, Sessions: 425-525 |
| Frontend UI & logic | `/Users/mini/github/toronto/web/templates/chat.html` | Alpine.js app: 350-562 |
| E2E tests | `/Users/mini/github/toronto/tests/e2e/test_sessions.py` | Full session test suite |

## Database Tables

### sessions
- `id` (TEXT PRIMARY KEY): UUID
- `title` (TEXT): Auto-generated from first message
- `created_at` (TEXT): ISO 8601 timestamp

### messages
- `id` (INTEGER PRIMARY KEY)
- `session_id` (TEXT): Foreign key → sessions.id (ON DELETE CASCADE)
- `role` (TEXT): 'user' or 'assistant'
- `content` (TEXT): Message text
- `sources_json` (TEXT): RAG sources as JSON
- `created_at` (TEXT): ISO 8601 timestamp

## API Endpoints

```
POST   /api/chat                           # Send message (creates session if needed)
POST   /api/sessions                       # Create session
GET    /api/sessions                       # List all sessions
GET    /api/sessions/<id>/messages         # Get all messages in session
DELETE /api/sessions/<id>                  # Delete session (cascades messages)
```

Missing:
- `PATCH /api/sessions/<id>` - Rename session (not implemented)

## Frontend State

```javascript
{
  messages: [],              // Chat messages in current view
  sessions: [],             // All sessions (from API)
  currentSessionId: null,   // Active session (null = new chat)
  userInput: '',            // Input field value
  isProcessing: false,      // Chat is loading
}
```

## Key Data Flows

### New Chat Flow
1. User types message → calls `sendMessage()`
2. POST `/api/chat` with message (no session_id)
3. Backend: `create_session()` → generates UUID
4. Backend: saves user message → LLM processing → saves assistant response
5. Response includes `session_id`
6. Frontend: updates `currentSessionId`, refreshes sessions list
7. Sidebar shows new session with auto-title

### Load Session Flow
1. User clicks session in sidebar → calls `loadSession(sessionId)`
2. GET `/api/sessions/<id>/messages`
3. Response: all messages for that session
4. Frontend: sets `currentSessionId`, populates `messages` array
5. Sidebar highlights active session with `btn-active` class

### Delete Session Flow
1. User clicks delete → calls `deleteSession(sessionId)` (needs implementation)
2. DELETE `/api/sessions/<id>`
3. Backend: deletes session + cascades to messages
4. Frontend: removes from sessions array, clears currentSessionId
5. Backend endpoint exists but frontend UI missing

## Title Generation

Automatic from first user message:
- Truncated to 50 chars
- If word is cut off, backtracks to last space
- Example: "How are you doing today?" → title is first 50 chars

Custom rename (not yet implemented):
- Would need PATCH endpoint + frontend UI

## Session Lifecycle

1. **Create**: POST /api/chat or POST /api/sessions
2. **Persist**: All messages stored with session_id
3. **Load**: GET /api/sessions/<id>/messages
4. **Delete**: DELETE /api/sessions/<id> (cascades)
5. **Rename**: Not implemented

## Where to Add Features

### Rename Session
1. Add `db.update_session_title()` in db.py (after line 562)
2. Add `ConversationManager.rename_session()` in manager.py (after line 165)
3. Add `PATCH /api/sessions/<id>` endpoint in main.py (after line 494)
4. Add rename UI (context menu/modal) in chat.html

### Delete Session UI
1. Add delete button/context menu in session items (chat.html sidebar)
2. Add confirmation dialog
3. Call existing DELETE endpoint
4. Refresh sessions list and clear view

## Testing

### E2E Tests
- File: `/Users/mini/github/toronto/tests/e2e/test_sessions.py`
- Run: `pytest tests/e2e/test_sessions.py`
- Key tests:
  - `test_new_chat_creates_session`: Verifies auto-session creation
  - `test_load_previous_session`: Verifies session persistence
  - `test_session_title_based_on_first_message`: Verifies auto-title
  - `test_session_persists_across_multiple_messages`: Verifies multi-turn

## Dependencies

- **Backend**: Quart (async Flask), SQLite, structlog
- **Frontend**: Alpine.js, marked.js (markdown), DOMPurify (sanitization), Tailwind + DaisyUI
- **Database**: SQLite (local file: `data/assistant.sqlite`)

## Notes

- Sessions use UUIDs for IDs (generated by ConversationManager)
- Messages use auto-increment integer IDs
- Cascade delete: deleting session automatically removes all messages
- Title only auto-updated on first message (subsequent messages don't change it)
- Timestamps in ISO 8601 format for consistency
- RAG sources stored as JSON in messages table
